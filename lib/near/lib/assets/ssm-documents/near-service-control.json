{
  "schemaVersion": "2.2",
  "description": "Start, stop, or restart NEAR blockchain service",
  "parameters": {
    "action": {
      "type": "String",
      "description": "Action to perform on NEAR service",
      "allowedValues": ["start", "stop", "restart", "status"],
      "default": "status"
    }
  },
  "mainSteps": [
    {
      "action": "aws:runShellScript",
      "name": "nearServiceControl",
      "inputs": {
        "timeoutSeconds": "120",
        "runCommand": [
          "#!/bin/bash",
          "set -e",
          "",
          "ACTION=\"{{ action }}\"",
          "echo \"=== NEAR Service Control: $ACTION ===\" | tee -a /var/log/near-service-control.log",
          "echo \"$(date): Performing $ACTION on NEAR service\" | tee -a /var/log/near-service-control.log",
          "",
          "case \"$ACTION\" in",
          "",
          "    \"start\")",
          "        echo '--- Starting NEAR service ---'",
          "        if systemctl is-active --quiet near.service; then",
          "            echo '✅ NEAR service is already running'",
          "        else",
          "            echo 'Starting NEAR service...'",
          "            systemctl start near.service",
          "            sleep 10",
          "            if systemctl is-active --quiet near.service; then",
          "                echo '✅ NEAR service started successfully'",
          "            else",
          "                echo '❌ Failed to start NEAR service'",
          "                systemctl status near.service --no-pager -l",
          "                exit 1",
          "            fi",
          "        fi",
          "        ;;",
          "",
          "    \"stop\")",
          "        echo '--- Stopping NEAR service ---'",
          "        if ! systemctl is-active --quiet near.service; then",
          "            echo '✅ NEAR service is already stopped'",
          "        else",
          "            echo 'Stopping NEAR service gracefully...'",
          "            systemctl stop near.service",
          "            sleep 5",
          "            if ! systemctl is-active --quiet near.service; then",
          "                echo '✅ NEAR service stopped successfully'",
          "            else",
          "                echo '⚠️  NEAR service is taking time to stop, waiting...'",
          "                sleep 15",
          "                if ! systemctl is-active --quiet near.service; then",
          "                    echo '✅ NEAR service stopped'",
          "                else",
          "                    echo '❌ NEAR service failed to stop gracefully'",
          "                    exit 1",
          "                fi",
          "            fi",
          "        fi",
          "        ;;",
          "",
          "    \"restart\")",
          "        echo '--- Restarting NEAR service ---'",
          "        echo 'Restarting NEAR service...'",
          "        systemctl restart near.service",
          "        sleep 10",
          "        if systemctl is-active --quiet near.service; then",
          "            echo '✅ NEAR service restarted successfully'",
          "        else",
          "            echo '❌ Failed to restart NEAR service'",
          "            systemctl status near.service --no-pager -l",
          "            exit 1",
          "        fi",
          "        ;;",
          "",
          "    \"status\")",
          "        echo '--- NEAR service status ---'",
          "        if systemctl is-active --quiet near.service; then",
          "            echo '✅ NEAR service is running'",
          "            echo ''",
          "            echo 'Service details:'",
          "            systemctl status near.service --no-pager -l",
          "            echo ''",
          "            echo 'Recent log entries:'",
          "            journalctl -u near.service -n 10 --no-pager",
          "        else",
          "            echo '❌ NEAR service is not running'",
          "            echo ''",
          "            echo 'Service details:'",
          "            systemctl status near.service --no-pager -l",
          "        fi",
          "        ;;",
          "",
          "    *)",
          "        echo '❌ Invalid action. Use: start, stop, restart, or status'",
          "        exit 1",
          "        ;;",
          "",
          "esac",
          "",
          "# Always show final status",
          "echo ''",
          "echo '--- Final Status ---'",
          "if systemctl is-active --quiet near.service; then",
          "    echo '✅ NEAR service is currently running'",
          "    # Quick health check",
          "    if curl -s -f http://localhost:8080/health >/dev/null; then",
          "        echo '✅ Health endpoint responding'",
          "    else",
          "        echo '⚠️  Health endpoint not yet ready'",
          "    fi",
          "else",
          "    echo '⭕ NEAR service is currently stopped'",
          "fi",
          "",
          "echo \"$(date): Service control action '$ACTION' completed\" | tee -a /var/log/near-service-control.log",
          ""
        ]
      }
    }
  ]
}
